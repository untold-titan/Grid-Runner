@page "/"
@using GridRunner.Blocks
@using GridRunner.Enums
@using GridRunner.Interfaces
@using GridRunner.Models
@using GridRunner.Services
@using GridRunner.Utilities
@inject IJSRuntime JS
@inject LevelLoaderService LevelLoader
@inject VehicleMovementService VehicleMovement
@inject BlockExecutionService BlockExecution

<PageTitle>Grid Runner</PageTitle>

<div class="game-header">
    <div class="brand">
        <h1>GRID RUNNER</h1>
    </div>

    <div class="controls-group">
        <div class="difficulty-selector">
            <select @bind="SelectedDifficulty">
                <option value="Easy">Easy (4×4)</option>
                <option value="Medium">Medium (5×5)</option>
                <option value="Hard">Hard (6×6)</option>
            </select>
        </div>

        <button class="btn btn-primary" @onclick="PlayRandomUnplayed" disabled="@GameWon">
            Play
        </button>
        <button class="btn btn-secondary" @onclick="ResetLevelAndUpdateUI">
            Reset
        </button>

        @if (GameWon)
        {
            <button class="btn btn-success" @onclick="PlayAgain">Play Again</button>
            <button class="btn btn-success" @onclick="PlayNextLevel">Next Level</button>
        }
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(StatusMessage) && !StatusMessage.StartsWith("Loaded level:"))
{
    <div class="status @(GameWon ? "win" : "")">@StatusMessage</div>
}

<div class="main-layout">
    <div class="panel">
        <div class="panel-header">BLOCKS</div>

        <details class="drop" open>
            <summary class="drop-title">
                Move
            </summary>
            <div class="drop-body">
                @foreach (var value in Enum.GetValues(typeof(MoveActionEnum)))
                {
                    <div class="panel-block"
                         @onpointerdown="(e) => OnPalettePointerDown(e, typeof(MoveBlock), (MoveActionEnum)value)">
                        <svg width="90" height="90" viewBox="0 0 92 92">
                            <path d="M 1 1 L 15 1 L 15 15 L 30 1 L 91 1 L 91 75 L 30 75 L 15 91 L 15 75 L 1 75 Z"
                                  fill="#d1d5db" stroke="#9ca3af" stroke-width="2" />
                            <text x="46" y="45" text-anchor="middle" font-size="14" font-weight="bold" fill="#1f2937">@value.ToString()</text>
                        </svg>
                    </div>
                }
            </div>
        </details>

        <details class="drop" open>
            <summary class="drop-title">
                Rotate
            </summary>
            <div class="drop-body">
                @foreach (var value in Enum.GetValues(typeof(RotateActionEnum)))
                {
                    <div class="panel-block"
                         @onpointerdown="(e) => OnPalettePointerDown(e, typeof(RotateBlock), (RotateActionEnum)value)">
                        <svg width="90" height="90" viewBox="0 0 92 92">
                            <path d="M 1 1 L 15 1 L 15 15 L 30 1 L 91 1 L 91 75 L 30 75 L 15 91 L 15 75 L 1 75 Z"
                                  fill="#d1d5db" stroke="#9ca3af" stroke-width="2" />
                            <text x="46" y="45" text-anchor="middle" font-size="12" font-weight="bold" fill="#1f2937">@(value.ToString() == "Clockwise" ? "CW" : "CCW")</text>
                        </svg>
                    </div>
                }
            </div>
        </details>

        <details class="drop" open>
            <summary class="drop-title">
                Wait
            </summary>
            <div class="drop-body">
                <div class="panel-block"
                     @onpointerdown="(e) => OnPalettePointerDown(e, typeof(WaitBlock), null)">
                    <svg width="90" height="90" viewBox="0 0 92 92">
                        <path d="M 1 1 L 15 1 L 15 15 L 30 1 L 91 1 L 91 75 L 30 75 L 15 91 L 15 75 L 1 75 Z"
                              fill="#d1d5db" stroke="#9ca3af" stroke-width="2" />
                        <text x="46" y="45" text-anchor="middle" font-size="14" font-weight="bold" fill="#1f2937">Wait</text>
                    </svg>
                </div>
            </div>
        </details>
    </div>

    <div class="stage" @ref="stageRef"
         @onpointermove="OnStagePointerMove"
         @onpointerup="OnStagePointerUp"
         @onpointercancel="OnStagePointerUp">

        <div class="stage-header">WORKSPACE</div>

        @if (hoverActive)
        {
            <div class="ghost"
                 style="left:@($"{hoverX}px"); top:@($"{hoverY}px");">
                <svg width="90" height="90" viewBox="0 0 92 92">
                    <path d="M 1 1 L 15 1 L 15 15 L 30 1 L 91 1 L 91 75 L 30 75 L 15 91 L 15 75 L 1 75 Z"
                          fill="transparent" stroke="#4f46e5" stroke-width="2" stroke-dasharray="5,5" opacity="0.5" />
                </svg>
            </div>
        }

        @foreach (var b in blocks)
        {
            <GridRunner.Components.CodeBlock block="b" onPointerDown="OnBlockPointerDown" isExecuting="@(currentlyExecutingBlockId == b.Id)" />
        }
    </div>

    <div class="grid-wrapper">
        <div class="compass-container">
            <div class="compass-label north">N ↑</div>
            <div class="compass-directions">
                <div class="compass-label west">W ←</div>
                <div class="compass-center"></div>
                <div class="compass-label east">→ E</div>
            </div>
            <div class="compass-label south">S ↓</div>
        </div>
        <div class="grid-header">GAME GRID</div>
        @{
            var (prefix, _, cellSizePx, cols) = GetGridRenderInfo();
            var (exitRow, exitCol) = GetExitRowCol(prefix);
            string exitClass = ExitSide.HasValue ? $"exit-{ExitSide.Value}" : "";

            string gridStyle =
            $"--cell-size:{cellSizePx}px;" +
            $"--cols:{cols};" +
            $"--exit-row:{exitRow};" +
            $"--exit-col:{exitCol};" +
            $"display:grid; grid-template-columns:repeat({cols},{cellSizePx}px);" +
            $"grid-auto-rows:{cellSizePx}px;";
        }

        <div class="grid-container @GridCssClass @exitClass" style="@gridStyle">
            @RenderGrid()
            @RenderVehicleSprites()
        </div>

        <div class="execute-section">
            <button class="btn btn-execute" @onclick="RunBlockStacks" disabled="@(GameWon || IsExecuting)">
                Execute Blocks
            </button>
            @if (HasSelection)
            {
                <div class="selected-info">
                    <span class="label">Selected:</span>
                    <span class="value">@SelectedVehicleDisplay</span>
                </div>
            }
        </div>
    </div>
</div>

@code {
    // Element reference for drag-and-drop
    private ElementReference stageRef;

    // UI State
    private string StatusMessage = "";

    // Properties delegated to services
    private string SelectedDifficulty
    {
        get => LevelLoader.SelectedDifficulty;
        set => LevelLoader.SelectedDifficulty = value;
    }

    private List<Vehicle> Vehicles => LevelLoader.Vehicles;
    private char? ExitSide => LevelLoader.ExitSide;
    private string? ExitCellKey => LevelLoader.ExitCellKey;
    private int? CurrentLevelIndex => LevelLoader.CurrentLevelIndex;

    private bool GameWon => VehicleMovement.GameWon;
    private bool HasSelection => VehicleMovement.HasSelection;
    private string SelectedVehicleDisplay => VehicleMovement.GetSelectedVehicleDisplay();

    private List<Block> blocks => BlockExecution.Blocks;
    private int? currentlyExecutingBlockId => BlockExecution.CurrentlyExecutingBlockId;
    private bool IsExecuting => BlockExecution.IsExecuting;
    private bool hoverActive => BlockExecution.HoverActive;
    private double hoverX => BlockExecution.HoverX;
    private double hoverY => BlockExecution.HoverY;

    private const string PaletteGray = "#DDDDDD";

    private string GridCssClass => SelectedDifficulty switch
    {
        "Easy" => "easy",
        "Medium" => "medium",
        "Hard" => "hard",
        _ => "easy"
    };

    // Event Handlers - Level Management
    private void PlayRandomUnplayed()
    {
        LevelLoader.PlayRandomUnplayed();
        BlockExecution.GenerateStartBlocksForVehicles();
        StatusMessage = LevelLoader.LastStatusMessage;
    }

    private void PlayAgain()
    {
        if (!string.IsNullOrWhiteSpace(LevelLoader.LastLevelLine))
        {
            LevelLoader.LoadLevelLine(LevelLoader.LastLevelLine!);
            BlockExecution.GenerateStartBlocksForVehicles();
        }
        else
        {
            ClearLevel();
        }
        StatusMessage = LevelLoader.LastStatusMessage;
    }

    private void PlayNextLevel()
    {
        ResetLevel();
        PlayRandomUnplayed();
    }

    private void ClearLevel()
    {
        LevelLoader.ClearLevel();
        BlockExecution.ClearBlocks();
        VehicleMovement.Reset();
        StatusMessage = "Cleared.";
    }

    // Event Handlers - Block System
    private async void OnBlockPointerDown(PointerEventArgs e, int id)
    {
        await BlockExecution.OnBlockPointerDown(e, id, stageRef);
    }

    private void OnStagePointerMove(PointerEventArgs e)
    {
        BlockExecution.OnStagePointerMove(e);
    }

    private void OnStagePointerUp(PointerEventArgs e)
    {
        BlockExecution.OnStagePointerUp(e);
    }

    private async Task OnPalettePointerDown(PointerEventArgs e, Type blockToInstantiate, Enum? action)
    {
        await BlockExecution.OnPalettePointerDown(e, blockToInstantiate, action, stageRef);
    }

    private async Task RunBlockStacks()
    {
        // Reset the level to initial state before execution
        ResetLevel();

        StatusMessage = await BlockExecution.RunBlockStacks(() => StateHasChanged());
        StateHasChanged();
    }

    private void ResetLevel()
    {
        if (!string.IsNullOrWhiteSpace(LevelLoader.LastLevelLine))
        {
            LevelLoader.LoadLevelLine(LevelLoader.LastLevelLine);
            VehicleMovement.Reset();
        }
    }

    private void ResetLevelAndUpdateUI()
    {
        ResetLevel();
        StatusMessage = "Level reset to initial state.";
    }

    // Helper Methods
    private (string Prefix, List<string> Cells, int CellSizePx, int Cols) GetGridRenderInfo()
    {
        return LevelLoader.GetGridRenderInfo();
    }

    private (int rowIndex, int colIndex) GetExitRowCol(string prefix)
    {
        return LevelLoader.GetExitRowCol(prefix);
    }

    // Render Grid - UI-specific logic
    private RenderFragment RenderGrid() => builder =>
    {
        var (prefix, cells, _, _) = GetGridRenderInfo();
        int seq = 0;

        var cellToVehicleIndex = new Dictionary<string, int>();
        for (int i = 0; i < Vehicles.Count; i++)
            foreach (var key in Vehicles[i].Cells)
                cellToVehicleIndex[key] = i;

        foreach (var cell in cells)
        {
            var key = prefix + cell;

            bool hasVehicle = cellToVehicleIndex.TryGetValue(key, out var vIndex);
            Vehicle? vehicle = hasVehicle ? Vehicles[vIndex] : null;

            bool isExit = (ExitCellKey == key);
            bool isSelected = HasSelection && hasVehicle && vIndex == VehicleMovement.SelectedVehicleIndex!.Value;

            string classes = "cell";
            // Don't add colored backgrounds - sprites will show instead
            if (vehicle != null) classes += " occupied";
            if (isExit && ExitSide.HasValue) classes += " exit exit-" + ExitSide.Value;
            // Don't add selected class to cells - sprites will show selection instead
            // if (isSelected) classes += " selected";

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", classes);
            builder.AddAttribute(seq++, "id", key);
            builder.AddContent(seq++, cell);

            if (vehicle != null && vehicle.Cells.Count > 0 && vehicle.Cells[0] == key)
            {
                builder.OpenElement(seq++, "div");
                builder.AddAttribute(seq++, "class", "veh-label");
                builder.AddContent(seq++, vehicle.Type.ToString());
                builder.CloseElement();
            }

            builder.CloseElement();
        }
    };

    private RenderFragment RenderVehicleSprites() => builder =>
    {
        var (prefix, _, cellSize, _) = GetGridRenderInfo();
        int seq = 0;

        for (int i = 0; i < Vehicles.Count; i++)
        {
            var v = Vehicles[i];
            if (v.Cells.Count == 0) continue;

            var labels = v.Cells.Select(k => StripPrefix(k, prefix)).ToList();

            var coords = labels.Select(lbl => ParseCell(lbl)).ToList();
            int minRow = coords.Min(rc => rc.row);
            int maxRow = coords.Max(rc => rc.row);
            int minCol = coords.Min(rc => rc.col);
            int maxCol = coords.Max(rc => rc.col);

            int angle = GetAngleFromPivotToNext(labels);

            // Calculate absolute position based on cell coordinates
            // ParseCell returns 1-based rows and 0-based cols
            // Position relative to grid-container top-left
            int left = minCol * cellSize;
            int top = (minRow - 1) * cellSize;  // minRow is 1-based, convert to 0-based

            // Calculate actual span in cells
            int spanCols = maxCol - minCol + 1;
            int spanRows = maxRow - minRow + 1;
            int width = spanCols * cellSize;
            int height = spanRows * cellSize;

            string containerStyle =
                $"position: absolute;" +
                $"left: {left}px;" +
                $"top: {top}px;" +
                $"width: {width}px;" +
                $"height: {height}px;";

            // Sprite should fill the entire container
            int innerW = width;
            int innerH = height;

            // Center the sprite in the container
            string imgStyle =
                $"position:absolute; left:50%; top:50%;" +
                $"width:{innerW}px; height:{innerH}px;" +
                $"transform: translate(-50%, -50%) rotate({angle}deg);" +
                $"transform-origin: center;";

            string classes = "veh-sprite";
            if (HasSelection && VehicleMovement.SelectedVehicleIndex!.Value == i) classes += " selected";

            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", classes);
            builder.AddAttribute(seq++, "style", containerStyle);

            builder.OpenElement(seq++, "img");
            builder.AddAttribute(seq++, "class", "veh-img");
            builder.AddAttribute(seq++, "src", GetSpritePath(v));
            builder.AddAttribute(seq++, "style", imgStyle);
            builder.AddAttribute(seq++, "draggable", "false");
            builder.CloseElement();

            builder.CloseElement();
        }
    };

    private static int GetAngleFromPivotToNext(List<string> labels)
    {
        if (labels.Count < 2) return 0;

        var (r0, c0) = ParseCell(labels[0]);
        var (r1, c1) = ParseCell(labels[1]);

        int dr = r1 - r0;
        int dc = c1 - c0;

        if (dr == 1 && dc == 0) return 0;
        if (dr == 0 && dc == 1) return 270;
        if (dr == -1 && dc == 0) return 180;
        if (dr == 0 && dc == -1) return 90;

        return 0;
    }

    private static string GetSpritePath(Vehicle v)
    {
        if (v.Type == 'P')
            return "/img/yellow-car.png";

        string color = v.Color switch
        {
            'R' => "red",
            'G' => "green",
            'B' => "blue",
            'Y' => "yellow",
            _ => "red"
        };

        string kind = v.Type switch
        {
            'C' => "car",
            'B' => "bus",
            'T' => "truck",
            _ => "car"
        };

        return $"/img/{color}-{kind}.png";
    }

    private static string StripPrefix(string key, string prefix)
    {
        if (key.StartsWith(prefix, StringComparison.Ordinal))
            return key.Substring(prefix.Length);
        return key;
    }

    private static (int row, int col) ParseCell(string cell)
    {
        cell = cell.Trim().ToUpper();
        string rowPart = cell[..^1];
        char colChar = cell[^1];

        if (!int.TryParse(rowPart, out int row)) throw new Exception($"Bad row in cell '{cell}'.");
        int col = colChar - 'A';
        return (row, col);
    }
}
<script>
    window.blockDrag = {
        rect: (el) => {
            const r = el.getBoundingClientRect();
            return { left: r.left, top: r.top };
        }
    };
</script>

<style>
    /* Game Header */
    .game-header {
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1.5rem;
        border-bottom: 1px solid #2a2a3e;
        background: #1a1a24;
    }

    .brand h1 {
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        color: #e8e8f0;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .level-badge {
        background: #4f46e5;
        padding: 0.35rem 0.9rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.03em;
        color: white;
    }

    .controls-group {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    /* Buttons */
    .btn {
        padding: 0.6rem 1.25rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn:not(:disabled):hover {
        opacity: 0.9;
    }

    .btn:not(:disabled):active {
        transform: scale(0.98);
    }

    .btn-primary {
        background: #4f46e5;
        color: white;
    }

    .btn-secondary {
        background: #475569;
        color: white;
    }

    .btn-success {
        background: #059669;
        color: white;
    }

    .btn-execute {
        background: #ea580c;
        color: white;
        font-size: 0.95rem;
        padding: 0.7rem 1.75rem;
    }

    /* Difficulty Selector */
    .difficulty-selector select {
        background: #252535;
        border: 1px solid #3a3a4e;
        color: #e8e8f0;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .difficulty-selector select:hover {
        border-color: #4f46e5;
        background: #2a2a3a;
    }

    .difficulty-selector select:focus {
        outline: none;
        border-color: #4f46e5;
    }

    /* Execute Bar */
    .execute-bar {
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #1a1a24;
        border-bottom: 1px solid #2a2a3e;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .selected-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.6rem 1.25rem;
        background: #252535;
        border-radius: 6px;
        border: 1px solid #3a3a4e;
    }

    .selected-info .label {
        color: #9ca3af;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .selected-info .value {
        color: #e8e8f0;
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* Status Message */
    .status {
        padding: 0.875rem 2rem;
        font-weight: 600;
        font-size: 0.95rem;
        color: #fbbf24;
        background: #2a2520;
        border-left: 3px solid #fbbf24;
    }

    .status.win {
        color: #10b981;
        background: #1a2a24;
        border-left-color: #10b981;
        font-size: 1.05rem;
    }

    /* Main Layout */
    .main-layout {
        display: flex;
        gap: 1.25rem;
        padding: 1.5rem 2rem;
        align-items: flex-start;
        height: calc(100vh - 200px);
    }

    /* Panel */
    .panel {
        width: 160px;
        flex-shrink: 0;
        background: #1f1f2e;
        border: 1px solid #2a2a3e;
        border-radius: 8px;
        padding: 0;
        display: flex;
        flex-direction: column;
        user-select: none;
        touch-action: none;
        height: 100%;
        overflow-y: auto;
    }

    .panel-header,
    .stage-header,
    .grid-header {
        padding: 0.875rem;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #9ca3af;
        background: #252535;
        border-bottom: 1px solid #2a2a3e;
        text-align: center;
    }

    .drop {
        margin: 0;
        border-bottom: 1px solid #2a2a3e;
    }

    .drop:last-child {
        border-bottom: none;
    }

    .drop-title {
        font-weight: 600;
        font-size: 0.8rem;
        padding: 0.7rem 1rem;
        cursor: pointer;
        background: #252535;
        transition: all 0.2s ease;
        color: #d1d5db;
    }

    .drop-title:hover {
        background: #2a2a3e;
        color: #e8e8f0;
    }

    .drop[open] .drop-title {
        background: #2a2a3e;
        border-bottom: 1px solid #3a3a4e;
    }

    .drop-body {
        padding: 0.75rem;
    }

    .panel-block {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: grab;
        user-select: none;
        margin-bottom: 0.5rem;
        transition: all 0.15s ease;
        background: #1a1a24;
    }

    .panel-block:hover {
        background: #252535;
    }

    .panel-block:active {
        cursor: grabbing;
        transform: scale(0.98);
    }

    /* Stage */
    .stage {
        position: relative;
        height: 100%;
        flex: 1;
        background: #1f1f2e;
        border: 1px solid #2a2a3e;
        border-radius: 8px;
        user-select: none;
        touch-action: none;
        overflow: visible;
        padding-top: 3.5rem;
    }

    .stage-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        border-radius: 8px 8px 0 0;
        margin-bottom: 15px;
    }

    .ghost {
        position: absolute;
        pointer-events: none;
        opacity: 0.6;
        z-index: 0;
    }

    /* Grid Wrapper */
    .grid-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #1f1f2e;
        border: 1px solid #2a2a3e;
        border-radius: 8px;
        padding: 0;
        width: 35%;
        flex-shrink: 0;
        height: 100%;
        position: relative;
        justify-content: space-between;
    }

    .execute-section {
        width: 100%;
        padding: 1.5rem 2rem;
        border-top: 1px solid #2a2a3e;
        background: rgba(26, 26, 36, 0.6);
        border-radius: 0 0 8px 8px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: center;
    }

    .execute-section .btn-execute {
        width: 100%;
        max-width: 300px;
    }

    .execute-section .selected-info {
        width: 100%;
        max-width: 300px;
        justify-content: center;
    }

    .grid-header {
        width: 100%;
        border-radius: 8px 8px 0 0;
        border-bottom: 1px solid #2a2a3e;
    }

    /* Compass */
    .compass-container {
        position: absolute;
        top: 4rem;
        right: 1rem;
        z-index: 100;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        background: rgba(31, 31, 46, 0.95);
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid #3a3a4e;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .compass-directions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .compass-center {
        width: 1rem;
        height: 1rem;
        background: #4f46e5;
        border-radius: 50%;
    }

    .compass-label {
        font-weight: 700;
        font-size: 0.75rem;
        color: #9ca3af;
        text-align: center;
        min-width: 2.5rem;
    }

    .compass-label.north {
        color: #4f46e5;
    }

    .compass-label.east,
    .compass-label.west,
    .compass-label.south {
        color: #9ca3af;
    }

    .grid-container {
        width: fit-content;
        position: relative;
        gap: 0;
        border: 2px solid #3a3a4e;
        background: #1a1a24;
        box-sizing: border-box;
        margin: 1.5rem auto;
        border-radius: 6px;
        overflow: visible;  /* Allow sprites to extend beyond if needed */
    }

    .cell {
        border: 1px solid #2a2a3e;
        background-color: #252535;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.8rem;
        position: relative;
        user-select: none;
        box-sizing: border-box;
        cursor: pointer;
        transition: all 0.15s ease;
        color: #6b7280;
    }

    .cell:hover {
        background-color: #2a2a3e;
        border-color: #3a3a4e;
    }

    .cell.selected {
        outline: 3px solid #4f46e5;
        outline-offset: -3px;
    }

    /* Occupied cells are now transparent to show sprites */
    .cell.occupied {
        background: transparent;
        border-color: #2a2a3e;
    }

    .veh-label {
        /* Hidden since we now use sprites */
        display: none;
    }

    .cell.exit.exit-A {
        border-left-color: #4f46e5;
        border-left-width: 2px;
    }

    .cell.exit.exit-B {
        border-top-color: #4f46e5;
        border-top-width: 2px;
    }

    .cell.exit.exit-C {
        border-right-color: #4f46e5;
        border-right-width: 2px;
    }

    .cell.exit.exit-D {
        border-bottom-color: #4f46e5;
        border-bottom-width: 2px;
    }

    .grid-container.exit-B::before,
    .grid-container.exit-D::before {
        content: "";
        position: absolute;
        left: calc(var(--exit-col) * var(--cell-size));
        width: var(--cell-size);
        height: 3px;
        background: #4f46e5;
        pointer-events: none;
        z-index: 10;
    }

    .grid-container.exit-B::before {
        top: -1.5px;
    }

    .grid-container.exit-D::before {
        bottom: -1.5px;
    }

    .grid-container.exit-A::before,
    .grid-container.exit-C::before {
        content: "";
        position: absolute;
        top: calc(var(--exit-row) * var(--cell-size));
        height: var(--cell-size);
        width: 3px;
        background: #4f46e5;
        pointer-events: none;
        z-index: 10;
    }

    .grid-container.exit-A::before {
        left: -1.5px;
    }

    .grid-container.exit-C::before {
        right: -1.5px;
    }

    /* Vehicle Sprites */
    .veh-sprite {
        z-index: 10;
        pointer-events: none;
        cursor: pointer;
        user-select: none;
        overflow: visible;
        background: transparent;
    }

    .veh-sprite.selected {
        outline: 4px solid rgba(79, 70, 229, 0.6);
        outline-offset: -4px;
    }

    .veh-img {
        object-fit: contain;
        image-rendering: pixelated;
        user-select: none;
        pointer-events: none;
        display: block;
        z-index: 2;
    }

    /* Scrollbar Styling */
    .panel::-webkit-scrollbar {
        width: 5px;
    }

    .panel::-webkit-scrollbar-track {
        background: #1a1a24;
    }

    .panel::-webkit-scrollbar-thumb {
        background: #3a3a4e;
        border-radius: 3px;
    }

    .panel::-webkit-scrollbar-thumb:hover {
        background: #4a4a5e;
    }

    /* Responsive Design */
    @@media (max-width: 1400px) {
        .main-layout {
            flex-direction: column;
            height: auto;
        }

        .panel {
            width: 100%;
            height: 250px;
            flex-direction: row;
            overflow-x: auto;
        }

        .stage {
            width: 100%;
            height: 400px;
        }

        .grid-wrapper {
            width: 100%;
            height: auto;
        }
    }

    @@media (max-width: 768px) {
        .game-header {
            padding: 1rem 1.5rem;
        }

        .brand h1 {
            font-size: 1.25rem;
        }

        .execute-bar {
            padding: 1rem 1.5rem;
            flex-direction: column;
            align-items: stretch;
        }

        .main-layout {
            padding: 1rem 1.5rem;
        }
    }
</style>